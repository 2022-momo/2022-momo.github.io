---
title: "ëª¨ëª¨íŒ€ ì„œë¹„ìŠ¤ ì„±ëŠ¥ ê°œì„ ê¸°3 (CUD ì¿¼ë¦¬ ê°œì„ )"
date: 2022-10-17
tags: ["SpringFramework", "ì„±ëŠ¥ ê°œì„ ê¸°", "CUD ì¿¼ë¦¬ ê°œì„ ", "orphanRemovalì˜ ë¬¸ì œ", "OneToMany ë‹¨ë°©í–¥ ê´€ê³„ì˜ ë¬¸ì œ"]
draft: false
---

# ë“¤ì–´ê°€ë©°

ëª¨ëª¨íŒ€ ì„œë¹„ìŠ¤ ê°œì„ ì„ í•˜ë©° ì§€ê¸ˆê¹Œì§€ ì˜ì¡´ê´€ê³„ì™€ ì¡°íšŒ ì¿¼ë¦¬ ê°œì„ ì„ ì§„í–‰í•˜ì˜€ë‹¤. ì´ë²ˆ í¬ìŠ¤íŠ¸ì—ì„œëŠ” ì§€ë‚œ ì¡°íšŒì¿¼ë¦¬ ê°œì„ ì— ì´ì–´ì„œ ë‚¨ì€ CUDê´€ë ¨ ê¸°ëŠ¥ì˜ ì¿¼ë¦¬ë¥¼ ë¶„ì„ ë° ê°œì„ í•˜ë©° ê²½í—˜í•œ ë‚´ìš©ì— ëŒ€í•´ ì •ë¦¬ë¥¼ í•´ë³´ë ¤ê³  í•œë‹¤.

> ì•ì„œ ì§„í–‰í•œ ì˜ì¡´ê´€ê³„ ê°œì„ ê³¼ ì¡°íšŒ ì¿¼ë¦¬ ê°œì„  ê´€ë ¨ ë‚´ìš©ì„ í™•ì¸í•˜ê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì˜ í¬ìŠ¤íŠ¸ë¥¼ í™•ì¸í•˜ê¸¸ ë°”ë€ë‹¤.
>
>
> [ëª¨ëª¨íŒ€ ì„œë¹„ìŠ¤ ì„±ëŠ¥ ê°œì„ ê¸°1 (ì˜ì¡´ê´€ê³„ ê°œì„ )](https://seongwon.dev/Spring/20221009-%EB%AA%A8%EB%AA%A8%ED%8C%80-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%84%B1%EB%8A%A5-%EA%B0%9C%EC%84%A0%EA%B8%B01/)
>
> [ëª¨ëª¨íŒ€ ì„œë¹„ìŠ¤ ì„±ëŠ¥ ê°œì„ ê¸°2 (ì¡°íšŒ ì¿¼ë¦¬ ê°œì„ )](https://seongwon.dev/Spring/20221014-%EB%AA%A8%EB%AA%A8%ED%8C%80-%EC%84%9C%EB%B9%84%EC%8A%A4%EC%84%B1%EB%8A%A5-%EA%B0%9C%EC%84%A0%EA%B8%B02/)
>

# ê°ì²´ ë° í…Œì´ë¸”ì˜ ì—°ê´€ê´€ê³„

ëª¨ë‘ëª¨ì—¬ë¼ ì„œë¹„ìŠ¤ëŠ” ëª¨ì„ ì„œë¹„ìŠ¤ì¸ë§Œí¼ ëª¨ì„(Group)ê°ì²´/í…Œì´ë¸”ì„ ì¤‘ì‹¬ìœ¼ë¡œ ë‹¤ë¥¸ ê°ì²´/í…Œì´ë¸”ë“¤ì´ ì—°ê´€ê´€ê³„ë¥¼ ë§ºê³  ìˆë‹¤.

![Untitled](image/20221017-ëª¨ëª¨íŒ€-ì„œë¹„ìŠ¤ì„±ëŠ¥-ê°œì„ ê¸°3/img.png)

![Untitled](image/20221017-ëª¨ëª¨íŒ€-ì„œë¹„ìŠ¤ì„±ëŠ¥-ê°œì„ ê¸°3/img_1.png)

ì‹¤ì œë¡œ ê°ì²´ì˜ ì—°ê´€ê´€ê³„ë¥¼ ë‚˜íƒ€ë‚¸ ì´ë¯¸ì§€ì™€ DB í…Œì´ë¸”ì˜ ë‹¤ì´ì–´ê·¸ë¨ì„ ì‚´í´ë³´ë©´ Groupì´ Member, Schedule, Participantì™€ ì—°ê´€ê´€ê³„ë¥¼ ë§ºê³  ìˆëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

# ê°œì„  ì „ ì¿¼ë¦¬ ë¶„ì„

ëª¨ì„ ê´€ë ¨ CUDë¡œì§ì„ ê°œì„ í•˜ê¸° ì•ì„œ ê°œì„  ì „ APIë³„ ì¿¼ë¦¬ë¥¼ ë¶„ì„í•œ ê²°ê³¼ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

![Untitled](image/20221017-ëª¨ëª¨íŒ€-ì„œë¹„ìŠ¤ì„±ëŠ¥-ê°œì„ ê¸°3/img_2.png)

ìš”ì²­ë³„ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ë¥¼ ë³´ë©´ ì…€ ìˆ˜ë„ ì—†ì´ ë§ì€ ì¿¼ë¦¬ë“¤ì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì‹¤ì œë¡œ ë„ˆë¬´ ë§ì€ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ì–´ ì¿¼ë¦¬ë¥¼ ë¶„ì„í•˜ëŠ” ê³¼ì •ì—ì„œ ê°ê°ì˜ ì¿¼ë¦¬ê°€ ì™œ ë‚˜ê°€ëŠ”ì§€ ì´í•´ ëª»í•˜ëŠ” ì¿¼ë¦¬ë“¤ì´ ì¡´ì¬í•˜ì—¬ ë¶„ì„ì— ì–´ë ¤ì›€ì„ ëŠë¼ê¸°ë„ í•˜ì˜€ë‹¤.

ì§€ê¸ˆë¶€í„° ë¬¸ì œê°€ ë§ì€ ì„œë¹„ìŠ¤ì˜ CUDê¸°ëŠ¥ë“¤ì˜ ì¿¼ë¦¬ë¥¼ ì–´ë–»ê²Œ ê°œì„ í•˜ì˜€ëŠ”ì§€ ìì„¸íˆ ì‚´í´ë³´ê² ë‹¤.

# Groupê³¼ Schedule..OneToMany ë‹¨ë°©í–¥ ê´€ê³„ì˜ ë¬¸ì œì 

ê¸°ì¡´ ì½”ë“œì—ì„œëŠ” Groupê³¼ Scheduleì€ 1:N ë‹¨ë°©í–¥ ê´€ê³„ë¡œ Groupì€ Scheduleì˜ ì¡´ì¬ë¥¼ ì•Œì§€ë§Œ Scheduleì€ Groupì˜ ì¡´ì¬ë¥¼ ì•Œì§€ ëª»í•˜ì˜€ë‹¤. í•˜ì§€ë§Œ DB í…Œì´ë¸” ìƒì—ì„œëŠ” ë°˜ëŒ€ë¡œ Scheduleì´ ì™¸ë˜í‚¤ë¡œ Groupì˜ idë¥¼ ê°–ê³  Groupì€ Schdeuleì˜ ì •ë³´ë¥¼ ì•Œì§€ ëª»í•˜ì˜€ë‹¤. ì´ì™€ ê°™ì´ ê°ì²´ì§€í–¥ ì½”ë“œì™€ ë°ì´í„°ë² ì´ìŠ¤ ìƒì—ì„œ ë¶ˆì¼ì¹˜ê°€ ì¡´ì¬í•˜ë”ë¼ë„ JPAëŠ” `@JoinColumn`ê³¼ ê°™ì€ ì–´ë…¸í…Œì´ì…˜ë“¤ì„ ì˜ ì„¤ì •í•´ì£¼ë©´ DBì— ì˜¬ë°”ë¥¸ í…Œì´ë¸”ì„ ë§Œë“¤ê³  ìë™ìœ¼ë¡œ ë§¤í•‘ê¹Œì§€ í•´ì¤€ë‹¤.

![Untitled](image/20221017-ëª¨ëª¨íŒ€-ì„œë¹„ìŠ¤ì„±ëŠ¥-ê°œì„ ê¸°3/img_3.png)

í•˜ì§€ë§Œ ì´ëŸ¬í•œ OneToMany ë‹¨ë°©í–¥ êµ¬ì¡°ëŠ” ê°œë°œìê°€ ì˜ë„í•˜ì§€ ì•Šì€ ì¿¼ë¦¬ë¥¼ ë°œìƒì‹œí‚¨ë‹¤ëŠ” ë¬¸ì œê°€ ì¡´ì¬í•œë‹¤. ë¬¸ì œì—ëŒ€í•´ ë”ìš± ìì„¸íˆ ì‚´í´ë³´ê² ë‹¤.

ê¸°ì¡´ ë¡œì§ì—ì„œëŠ” ëª¨ì„ì„ ë§Œë“¤ê³  ì¼ì • ë°ì´í„°ì¸ Scheduleì„ ê°ì²´ì§€í–¥ì ìœ¼ë¡œ í”„ë¡œê·¸ë˜ë°í•˜ë©° Javaì˜ ì»¬ë ‰ì…˜ì— ë°ì´í„°ë¥¼ ë„£ëŠ” ê²ƒì²˜ëŸ¼ Groupê°ì²´ë¥¼ ë§Œë“¤ ë•Œ ìƒì„±ìë¥¼ í†µí•´ ì£¼ì…í•˜ë„ë¡ ì‘ì„±í•˜ì˜€ë‹¤.

```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class Group {

    @Id
    @GeneratedValue(strategy = GenerationType.IDENTITY)
    private Long id;

    @OneToMany(orphanRemoval = true, cascade = CascadeType.PERSIST)
    @JoinColumn(name = "group_id")
    private final List<Schedule> schedules = new ArrayList<>();

    public Group(List<Schedule> schedules, ...) {
        this.schedules = schedules;
        ...
    }
    ...
}
```

> ğŸ“ŒÂ ì‹¤ì œ ì½”ë“œëŠ” ì¼ê¸‰ ì»¬ë ‰ì…˜ê³¼ ê°’ ê°ì²´ë“¤ë¡œ ì´ë£¨ì–´ì ¸ìˆì–´ ìœ„ì˜ ì½”ë“œëŠ” ë…ìë“¤ì˜ ì´í•´ë¥¼ ë•ê³ ì í•„ìš”í•œ ë¶€ë¶„ì„ ì¶”ì¶œí•˜ì—¬ ì½”ë“œë¡œ í‘œí˜„í–ˆìŠµë‹ˆë‹¤.
>

ìœ„ì™€ ê°™ì´ ì½”ë“œë¥¼ ì‘ì„±í•œ ì´ìœ ëŠ” ê°ì²´ì§€í–¥ì ì¸ ì½”ë“œë¥¼ ìƒê°í•˜ì˜€ì„ ë•Œ í•´ë‹¹ ì½”ë“œì™€ ê°™ì€ ë°©ì‹ì´ ì˜¬ë°”ë¥´ë‹¤ê³  ìƒê°í–ˆê¸° ë•Œë¬¸ì´ë‹¤. ê·¸ë¦¬ê³  ë°ì´í„° ì €ì¥ì— ëŒ€í•œ ê²°ê³¼ë¥¼ ë´¤ì„ ë•Œ `ScheduleRepository`ì— ì ‘ê·¼í•˜ì—¬ ì§ì ‘ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ì§€ ì•Šì•„ë„ JPAëŠ” Schedule í…Œì´ë¸”ì— ì¼ì • ë°ì´í„°ë¥¼ ì €ì¥í•´ì¤¬ê¸°ì— ê´œì°®ì€ ë°©ë²•ì´ë¼ ìƒê°í–ˆë‹¤.

í•˜ì§€ë§Œ 1:N ë‹¨ë°©í–¥ ê´€ê³„ì—ì„œ ì—°ê´€ê´€ê³„ ì£¼ì¸ì´ 1ì´ ë˜ëŠ” ë°©ë²•ì€ ìƒì„± ë¡œì§ì„ ìˆ˜í–‰í•´ë³´ë©´ ì¹˜ëª…ì ì¸ ë‹¨ì ì„ ë°œê²¬í•  ìˆ˜ ìˆë‹¤. ì¼ë°˜ì ìœ¼ë¡œ ì¼ì •ì„ ë‹´ì€ ëª¨ì„ ìƒì„±ì„ í•  ë•Œ ìš°ë¦¬ëŠ” ëª¨ì„ insert, ì¼ì • insert ì´ë ‡ê²Œ ë‘ ì¢…ë¥˜ì˜ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ ì˜ˆìƒí•  ê²ƒì´ë‹¤. ì‹¤ì œë¡œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ëŠ” ì–´ë–¨ê¹Œ..? í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³¸ ê²°ê³¼ ìš°ë¦¬ì˜ ì˜ˆìƒê³¼ëŠ” ë„ˆë¬´ë‚˜ë„ ë‹¤ë¥¸ ì¿¼ë¦¬ê°€ ì‹¤í–‰ëœ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤. ì‹¤í–‰ëœ ì¿¼ë¦¬ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```sql
Hibernate: 
    insert 
    into
        momo_group
        (id, deadline, endDate, startDate, category, closedEarly, description, locationAddress, locationBuildingName, locationDetail, name, capacity, host_id) 
    values
        (default, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: 
    insert 
    into
        momo_schedule
        (id, date, endTime, startTime) 
    values
        (default, ?, ?, ?)
Hibernate: 
    insert 
    into
        momo_schedule
        (id, date, endTime, startTime) 
    values
        (default, ?, ?, ?)
Hibernate: 
    update
        momo_schedule 
    set
        group_id=? 
    where
        id=?
Hibernate: 
    update
        momo_schedule 
    set
        group_id=? 
    where
        id=?
```

ëª¨ì„ê³¼ ì¼ì •ì„ Insertí•˜ëŠ” ì¿¼ë¦¬ê¹Œì§€ëŠ” ì˜ˆìƒí–ˆë˜ ì¿¼ë¦¬ë¼ ë¬¸ì œê°€ ì—†ì—ˆë‹¤. í•˜ì§€ë§Œ ê·¸ ì´í›„ì— ë‚˜ì˜¤ëŠ” Updateì¿¼ë¦¬ëŠ” ë„ëŒ€ì²´ ì™œ ë‚˜ì˜¨ ê²ƒì¼ê¹Œ?? í•´ë‹¹ ì¿¼ë¦¬ê°€ ì‹¤í–‰ë˜ëŠ” ì´ìœ ëŠ” JPAì—ì„œ Scheduleì„ ì²˜ìŒ DBì— ì €ì¥í•  ë•Œ GroupIdë¥¼ ëª¨ë¥´ê¸° ë•Œë¬¸ì— Groupì˜ Idì—†ì´ Scheduleì˜ ë°ì´í„°ê°€ ë¨¼ì € ì €ì¥ë˜ê³  ê·¸ í›„ì— ë¹„ì–´ìˆëŠ” Scheduleì˜ GroupId ì»¬ëŸ¼ ë°ì´í„°ë¥¼ ì±„ì›Œì£¼ê¸° ìœ„í•´ Updateì¿¼ë¦¬ê°€ ë‚ ë¦¬ê¸° ë•Œë¬¸ì´ë‹¤.

ìƒì„±ì—ì„œë„ ë¬¸ì œê°€ ë°œìƒí•˜ì§€ë§Œ ì‚­ì œí•  ë•Œë„ ìš°ë¦¬ì˜ ì˜ˆìƒê³¼ ë‹¤ë¥¸ ì¿¼ë¦¬ë“¤ì´ ë°œìƒí•œë‹¤. ëª¨ì„ ì‚­ì œ ìš”ì²­ì„ í•˜ì˜€ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ëŠ” ì•„ë˜ì™€ ê°™ë‹¤.

```sql
Hibernate: 
    delete 
    from
        momo_favorite 
    where
        group_id=?
Hibernate: 
    select
        value0_.group_id as group_id5_4_0_,
        value0_.id as id1_4_0_,
        value0_.id as id1_4_1_,
        value0_.date as date2_4_1_,
        value0_.endTime as endtime3_4_1_,
        value0_.startTime as starttim4_4_1_ 
    from
        momo_schedule value0_ 
    where
        value0_.group_id=?
Hibernate: 
    update
        momo_schedule 
    set
        group_id=null 
    where
        group_id=?
Hibernate: 
    delete 
    from
        momo_schedule 
    where
        id=?
Hibernate: 
    delete 
    from
        momo_schedule 
    where
        id=?
Hibernate: 
    delete 
    from
        momo_group 
    where
        id=?
```

ìƒì„±ì— ì´ì–´ ì‚­ì œë¥¼ í•  ë•Œë„ ì¼ë°˜ì ìœ¼ë¡œ ì˜ˆìƒë˜ëŠ” ì¿¼ë¦¬ëŠ” Delete Groupê³¼ Delete Schedule ì¿¼ë¦¬ê°€ ë°œìƒë˜ì–´ì•¼ í•˜ëŠ”ë° ì¤‘ê°„ì— Scheduleì˜ GroupIdë¥¼ `null`ë¡œ ë³€í™˜í•˜ëŠ” ì˜ˆìƒí•˜ì§€ ëª»í•œ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ì˜€ë‹¤. í•´ë‹¹ ì¿¼ë¦¬ë„ ë°”ë¡œ 1:N ë‹¨ë°©í–¥ ê´€ê³„ì—ì„œ ë‚˜ì˜¤ëŠ” ë¬¸ì œì ì´ì—ˆë‹¤.

> Schedule ìœ ë¬´ì— ëŒ€í•œ ì¡°íšŒ ì¿¼ë¦¬ì™€ Scheduleì„ ì§ì ‘ ì‚­ì œí•˜ëŠ” ì¿¼ë¦¬ëŠ” `orphanRemoval`ì˜µì…˜ì„ í™œì„±í™”ì‹œì¼œì„œ ì‹¤í–‰ëœ ì¿¼ë¦¬ì´ë‹¤. í•´ë‹¹ ì˜µì…˜ì„ ì‹¤í–‰í•˜ì§€ ì•Šìœ¼ë©´ í•´ë‹¹ ì¿¼ë¦¬ë“¤ì€ ë°œìƒí•˜ì§€ ì•Šì„ ê²ƒì´ë‹¤.
>

í•´ë‹¹ ë¬¸ì œëŠ” 1:N ë‹¨ë°©í–¥ ê´€ê³„ë¥¼ ì–‘ë°©í–¥ ê´€ê³„ë¡œ ìˆ˜ì •í•˜ë©° í•´ê²°í•  ìˆ˜ ìˆë‹¤. ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ëŠ” ì„œë¡œë¥¼ ì˜ì¡´í•˜ê²Œë˜ì–´ ì‹ ê²½ì¨ì•¼ í•  ë¶€ë¶„ì´ ë§ì•„ ê°€ê¸‰ì  ì‚¬ìš©í•˜ì§€ ì•ŠëŠ” ê²ƒì´ ì¢‹ë‹¤. í•˜ì§€ë§Œ í•´ë‹¹ ë¶€ë¶„ì— ëŒ€í•´ì„œëŠ” ë‹¨ë°©í–¥ ê´€ê³„ë¥¼ ê±¸ê²Œ ëœë‹¤ë©´ ê°œë°œìë“¤ì´ ì˜ˆìƒí•˜ì§€ ëª»í•œ ì¿¼ë¦¬ë¥¼ ë°œìƒì‹œì¼œ ê°œë°œì— í˜¼ë€ì„ ì¤„ ìˆ˜ ìˆê¸°ì— ì–‘ë°©í–¥ ê´€ê³„ë¥¼ ê±¸ì–´ì£¼ëŠ” ê²ƒì´ ì¢‹ë‹¤.

> ì–‘ë°©í–¥ ê´€ê³„ëŠ” â€˜í•˜ë©´ ì•ˆë˜ëŠ” ê²ƒâ€™ì´ ì•„ë‹Œ â€˜ìœ„í—˜í•˜ì—¬ ì£¼ì˜í•´ì•¼í•˜ëŠ” ê²ƒâ€™ì´ë‹¤. ë¬´ì¡°ê±´ í”¼í•˜ê¸°ë³´ë‹¤ í•„ìš”ì— ë”°ë¼ ì–‘ë°©í–¥ ì—°ê´€ê´€ê³„ë¥¼ ë§Œë“¤ê¸°ë„ í•´ì•¼í•œë‹¤.
>

> 1:N ì—°ê´€ê´€ê³„ì— ëŒ€í•´ ìì„¸íˆ ì•Œê³  ì‹¶ë‹¤ë©´ ì•„ë˜ì˜ í¬ìŠ¤íŠ¸ë¥¼ ì°¸ê³ í•˜ê¸¸ ë°”ë€ë‹¤.
>
>
> [[JPA] ì—”í‹°í‹°ê°„ ì—°ê´€ê´€ê³„](https://seongwon.dev/Spring/20220824-JPA-%EC%97%94%ED%8B%B0%ED%8B%B0%EA%B0%84_%EC%97%B0%EA%B4%80%EA%B4%80%EA%B3%84/#52-%EC%9D%BC%EB%8C%80%EB%8B%A4-1n)
>

ëª¨ì„ê³¼ ì¼ì •ì˜ ê´€ê³„ë¥¼ ë‹¨ë°©í–¥ì—ì„œ ì–‘ë°©í–¥ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê³¼ì •ì„ ì§„í–‰í•œ í›„, ëª¨ì„ ìƒì„± ìš”ì²­ì—ì„œ ì‹¤í–‰ëœ ì¿¼ë¦¬ë¥¼ í™•ì¸í•´ë³¸ ê²°ê³¼ ì´ˆê¸°ì— ìš°ë¦¬ê°€ ì˜ˆìƒí–ˆë˜ ì¿¼ë¦¬ë“¤ë§Œì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆì—ˆë‹¤.

```sql
Hibernate: 
    select
        member0_.id as id1_2_0_,
        member0_.deleted as deleted2_2_0_,
        member0_.password as password3_2_0_,
        member0_.user_id as user_id4_2_0_,
        member0_.name as name5_2_0_ 
    from
        momo_member member0_ 
    where
        member0_.id=?
Hibernate: 
    insert 
    into
        momo_group
        (id, deadline, endDate, startDate, category, closedEarly, description, locationAddress, locationBuildingName, locationDetail, name, capacity, host_id) 
    values
        (default, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?, ?)
Hibernate: 
    insert 
    into
        momo_schedule
        (id, date, endTime, group_id, startTime) 
    values
        (default, ?, ?, ?, ?)
Hibernate: 
    insert 
    into
        momo_schedule
        (id, date, endTime, group_id, startTime) 
    values
        (default, ?, ?, ?, ?)
```

ğŸ¤“ 1:N ë‹¨ë°©í–¥ì„ ì–‘ë°©í–¥ìœ¼ë¡œ ë³€ê²½í•˜ëŠ” ê³¼ì •ì—ì„œ JPAì—ê²Œ ìœ„ì„í•˜ì˜€ë˜ Schedule ë°ì´í„°ì˜ ì €ì¥ì„ ìœ„í•´`ScheduleRepository`ê°€ ë§Œë“¤ì–´ì§€ê³  ì €ì¥ ë¡œì§ì´ Serviceë ˆì´ì–´ê¹Œì§€ ì˜¬ë¼ê°€ëŠ” ê°ì²´ì§€í–¥ê³¼ ë©€ì–´ì§€ëŠ” ë³€í™”ê°€ ìˆì—ˆë‹¤. í•˜ì§€ë§Œ í•´ë‹¹ ë³€í™”ë¥¼ ê±°ì¹˜ë©° ì˜ˆìƒí•˜ì§€ ëª»í•œ ì¿¼ë¦¬ê°€ ì‚¬ë¼ì§€ê²Œ ë˜ì–´ ìœ ì§€ë³´ìˆ˜ ì¸¡ë©´ì—ì„œëŠ” í›¨ì”¬ ê°œì„ ë˜ì—ˆë‹¤ê³  ìƒê°ëœë‹¤.

# orphanRemovalì— ì˜ì¡´ì ì¸ ì‚­ì œ ë¡œì§ì˜ ë¬¸ì œì 

í”„ë¡œì íŠ¸ë¥¼ ì§„í–‰í•˜ë©° ëª¨ëª¨íŒ€ì€ ìµœëŒ€í•œ ê°ì²´ì§€í–¥ì ì¸ ì½”ë“œë¥¼ ì‘ì„±í•˜ê¸° ìœ„í•´ orphanRemovalê³¼ Cascadeì˜µì…˜ì„ í™œìš©í•˜ì—¬ ëª¨ì„ì— ì°¸ì—¬ì ë˜ëŠ” ì¼ì •ì´ ì¶”ê°€ë˜ê±°ë‚˜ ë¹ ì¡Œì„ ë•Œ, ê°ê°ì˜ ì»¬ë ‰ì…˜ì— ë°ì´í„°ë¥¼ `add()`, `remove()` ë©”ì„œë“œë¥¼ í†µí•´ ë°ì´í„°ì˜ Insert, Deleteê°€ ì´ë£¨ì–´ì§€ë„ë¡ í•˜ì˜€ë‹¤.

ê¸°ì¡´ì— ëª¨ì„ì„ ì‚­ì œí•˜ì˜€ì„ ë•Œ participantì™€ schedule ë°ì´í„°ë“¤ì˜ ì‚­ì œë„ `orphanRemoval`ì„ í†µí•´ ì‚­ì œë˜ë„ë¡ ì§„í–‰í•˜ì˜€ì—ˆë‹¤. í•˜ì§€ë§Œ ì¿¼ë¦¬ ë¶„ì„ì„ í•˜ë©° í•´ë‹¹ ë¶€ë¶„ì— ëŒ€í•´ì„œë„ ì˜ˆìƒí•˜ì§€ ëª»í•œ ì¿¼ë¦¬ê°€ ë°œìƒí•œ ê²ƒì„ í™•ì¸í•˜ì˜€ë‹¤. ëª¨ì„ ì‚­ì œë¥¼ í•˜ì˜€ì„ ë•Œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ ì¤‘ì— Scheduleê³¼ Participantì˜ ì‚­ì œ ì¿¼ë¦¬ì— ëŒ€í•´ ìì„¸íˆ ì‚´í´ë³´ê² ë‹¤.

![Untitled](image/20221017-ëª¨ëª¨íŒ€-ì„œë¹„ìŠ¤ì„±ëŠ¥-ê°œì„ ê¸°3/img_4.png)

ìœ„ì˜ ì¿¼ë¦¬ë“¤ì„ ì‚´í´ë³´ë©´ ì—°ê´€ëœ ì¼ì •ê³¼ ì°¸ì—¬ì ë°ì´í„°ê°€ ì¡´ì¬í•˜ëŠ”ì§€ë¥¼ í™•ì¸í•˜ëŠ” ì¡°íšŒ ì¿¼ë¦¬ì™€ ê°ê°ì˜ ë°ì´í„°ë“¤ì„ ì‚­ì œí•˜ëŠ” Nê°œì˜ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ê°œì¸ì ìœ¼ë¡œ ê³ ì•„ê°ì²´ë“¤ì´ ì¡´ì¬í•˜ëŠ”ì§€ì˜ ì¡°íšŒ ì¿¼ë¦¬ëŠ” ì“°ë ˆê¸° ë°ì´í„°ë¥¼ ë‚¨ê¸°ì§€ ì•Šê¸° ìœ„í•´ ì–‘ë³´í•  ìˆ˜ ìˆëŠ” ì¿¼ë¦¬ë¼ ìƒê°í•œë‹¤. í•˜ì§€ë§Œ ì‚­ì œëœ ëª¨ì„ê³¼ ì—°ê´€ëœ Nê°œì˜ ë°ì´í„°ë“¤ì„ ê°ê° Deleteì¿¼ë¦¬ë¥¼ ê°œë³„ë¡œ ì‹¤í–‰í•˜ì—¬ ì‚­ì œí•˜ëŠ” ê²ƒì€ í° ë¬¸ì œê°€ ìˆë‹¤ê³  ìƒê°ë˜ì–´ ì´ë¥¼ Serviceë ˆì´ì–´ì—ì„œ GroupIdë¥¼ í†µí•´ ì—°ê´€ëœ Scheduleê³¼ Participantë°ì´í„°ë¥¼ ëª¨ë‘ ì‚­ì œí•˜ëŠ” ë°©ì‹ìœ¼ë¡œ ì½”ë“œë¥¼ ìˆ˜ì •í•˜ì˜€ë‹¤.

```java
@RequiredArgsConstructor
@Transactional(readOnly = true)
@Service
public class GroupModifyService {
	// ê¸°ì¡´ ì½”ë“œ
	@Transactional
    public void delete(Long hostId, Long groupId) {
        ifMemberIsHost(hostId, groupId, (host, group) -> {
            group.validateGroupIsProceeding();
            applicationEventPublisher.publishEvent(new GroupDeleteEvent(groupId));
            groupRepository.deleteById(groupId);
        });
    }
	// ë³€ê²½ í›„ ì½”ë“œ
	@Transactional
    public void delete(Long hostId, Long groupId) {
        ifMemberIsHost(hostId, groupId, (host, group) -> {
            group.validateGroupIsProceeding();
            applicationEventPublisher.publishEvent(new GroupDeleteEvent(groupId));
            scheduleRepository.deleteAllByGroupId(groupId);
            participantRepository.deleteAllByGroupId(groupId);
            groupRepository.deleteById(groupId);
        });
    }
```

ê¸°ì¡´ì—ëŠ” ëª¨ì„ ì‚­ì œë¥¼ í•  ë•Œ, ë‹¨ìˆœíˆ `groupRepository.deleteById(groupId);` ë§Œì„ ì‹¤í–‰ì‹œì¼°ë˜ ë¡œì§ì„ `scheduleRepository`ì™€ `participantRepository`ì˜ `deleteAllByGroupId();` ë¥¼ ê°ê° ì‹¤í–‰ì‹œí‚¤ë„ë¡ ìˆ˜ì •í•œ ê²°ê³¼ ì•„ë˜ì™€ ê°™ì´ ëª¨ì„ ì‚­ì œë¥¼ ìš”ì²­í•˜ì˜€ì„ ë•Œ ë°œìƒí•˜ëŠ” Nê°œì˜ ì¿¼ë¦¬ë“¤ì„ ëª¨ë‘ ì œê±°í•  ìˆ˜ ìˆì—ˆë‹¤.

```sql
Hibernate: 
    delete 
    from
        momo_favorite 
    where
        group_id=?
Hibernate: 
    delete 
    from
        momo_schedule 
    where
        group_id=?
Hibernate: 
    delete 
    from
        momo_participant 
    where
        group_id=?
Hibernate: 
    delete 
    from
        momo_group 
    where
        id=?
```

# ëª¨ì„ ìˆ˜ì • ë¡œì§ì˜ ë¬¸ì œì 

ëª¨ëª¨íŒ€ ì„œë¹„ìŠ¤ ì¿¼ë¦¬ ë¶„ì„ì„ í•˜ë©° ê°€ì¥ ë¬¸ì œê°€ ë§ì•˜ë˜ APIëŠ” ë°”ë¡œ ëª¨ì„ ì •ë³´ ì—…ë°ì´íŠ¸ì´ë‹¤. JPAëŠ” íŠ¸ëœì­ì…˜ ì•ˆì—ì„œ ì²˜ìŒ ì—”í‹°í‹° ë°ì´í„°ë¥¼ ì½ì–´ì™”ì„ ë•Œì™€ íŠ¸ëœì­ì…˜ì´ ëë‚˜ì„œ entityManagerê°€ flushë  ë•Œ ê°ì²´ì˜ ë³€í™”ê°€ ìƒê¸°ë©´ Dirty Checkingì„ í•˜ì—¬ ë³€ê²½ëœ ë°ì´í„°ì— ëŒ€í•´ Updateì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì¤€ë‹¤. ê·¸ë ‡ê¸°ì— ì—…ë°ì´íŠ¸ ë¡œì§ì„ ì‚´í´ë³´ë©´ Scheduleì„ ì œì™¸í•œ ë‹¤ë¥¸ ëª¨ì„ ì •ë³´ ë°ì´í„°ë“¤ì€ ê°ì²´ì˜ ê°’ì„ ì¬í• ë‹¹í•˜ëŠ” ê³¼ì •ë§Œì„ ì§„í–‰í•˜ê³  ìˆì—ˆë‹¤.

```java
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Entity
public class Group {
	...
	public void update(Capacity capacity, Calendar calendar, GroupName name, Category category,
                       Location location, Description description) {
        validateGroupIsProceeding();
        this.participants.updateCapacity(capacity);
        this.calendar.update(calendar.getDeadline(), calendar.getDuration(), calendar.getSchedules());
        this.name = name;
        this.category = category;
        this.location = location;
        this.description = description;
    }
}
```

Scheduleì˜ ê²½ìš° `final`ë¡œ ì¬í• ë‹¹ì´ ë§‰íŒ `List`ì´ê¸°ì— ì¬í• ë‹¹ì´ ì•„ë‹Œ `clear()`ë¥¼ í†µí•œ ì´ˆê¸°í™”ì™€ `addAll()`ì„ í†µí•œ ë°ì´í„° ì¶”ê°€ë¥¼ ì§„í–‰í•˜ì˜€ë‹¤.

```java
@Getter
@NoArgsConstructor(access = AccessLevel.PROTECTED)
@Embeddable
public class Schedules {

    @OneToMany(orphanRemoval = true, cascade = CascadeType.PERSIST)
    @JoinColumn(name = "group_id")
    private final List<Schedule> value = new ArrayList<>();

    public Schedules(List<Schedule> schedules) {
        value.addAll(schedules);
    }

    public void change(Schedules schedules) {
        value.clear();
        value.addAll(schedules.value);
    }
}
```

`clear()`ê³¼ `addAll()`ê³¼ì •ì„ ê±°ì³¤ì„ ë•Œ Scheduleë„ ë‹¤ë¥¸ ë°ì´í„°ë“¤ì²˜ëŸ¼ Dirty Checkingì„ í•˜ë©° ê¸°ì¡´ì— ì—†ë˜ ì¼ì •ì— ëŒ€í•´ì„œë§Œ ì—…ë°ì´íŠ¸ ì¿¼ë¦¬ë¥¼ ë‚ ë ¤ì£¼ë©´ ì¢‹ì„ í…ë° ì‹¤ì œ ë™ì‘ì€ ê·¸ë ‡ì§€ ëª»í•œë‹¤. Scheduleì€ ë³„ë„ì˜ í…Œì´ë¸”ì— ì €ì¥ë˜ì–´ idê°’ì„ í• ë‹¹ë°›ê¸°ì— ê°™ì€ ì¼ì •ì— ëŒ€í•´ì„œë„ idê°’ì˜ ìœ ë®¤ ì°¨ì´ê°€ ë°œìƒí•˜ì—¬ JPAëŠ” ë‹¤ë¥¸ ê°ì²´ë¡œ ì¸ì§€í•œë‹¤. ê·¸ ê²°ê³¼ ê¸°ì¡´ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ëŠ” Deleteì¿¼ë¦¬ì™€ ìƒˆë¡œìš´ ë°ì´í„°ë¥¼ ì¶”ê°€í•˜ëŠ” Insertì¿¼ë¦¬ë¥¼ ë‚ ë¦¬ê²Œ ëœë‹¤.

ì´ëŸ¬í•œ ë™ì‘ì€ ëª¨ëª¨íŒ€ì˜ ì—…ë°ì´íŠ¸ ìš”ì²­ ì²˜ë¦¬ ì„±ëŠ¥ìƒì— í° ì €í•˜ë¥¼ ë¶ˆëŸ¬ì¼ìœ¼ì¼°ë‹¤. ì¼ì • ë³€ê²½ì˜ ìœ ë¬´ì™€ ìƒê´€ì—†ì´ `List<Schedule>`ì„ `clear()`, `addAll()` ì„ ì§„í–‰í•˜ë‹¤ë³´ë‹ˆ ë§¤ë²ˆ ë¶ˆí•„ìš”í•œ Schedule Delete, Updateì¿¼ë¦¬ê°€ ë°œìƒí•˜ê²Œ ë˜ì—ˆë‹¤. ì‹¤ì œë¡œ 2ê°œì˜ ì¼ì •ì´ ìˆëŠ” ëª¨ì„ì— ê°™ì€ ì¼ì •ì„ ë‹´ì•„ ìš”ì²­ì„ ë³´ë‚¼ ê²½ìš°, ì‹¤ì œ ì¼ì • ê°’ì—ëŠ” ë³€í™”ê°€ ì—†ì§€ë§Œ í•´ë‹¹ ë°ì´í„°ë¥¼ ìƒˆë¡œ ì¶”ê°€í•˜ê³  ê¸°ì¡´ì˜ ë°ì´í„°ë¥¼ ì‚­ì œí•˜ëŠ” ì¿¼ë¦¬ë“¤ì´ ì‹¤í–‰ë˜ëŠ” ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤.

```sql
Hibernate: 
    insert 
    into
        momo_schedule
        (id, date, endTime, startTime) 
    values
        (default, ?, ?, ?)
Hibernate: 
    insert 
    into
        momo_schedule
        (id, date, endTime, startTime) 
    values
        (default, ?, ?, ?)
Hibernate: 
    update
        momo_schedule 
    set
        group_id=null 
    where
        group_id=? 
        and id=?
Hibernate: 
    update
        momo_schedule 
    set
        group_id=null 
    where
        group_id=? 
        and id=?
Hibernate: 
    update
        momo_schedule 
    set
        group_id=? 
    where
        id=?
Hibernate: 
    update
        momo_schedule 
    set
        group_id=? 
    where
        id=?
Hibernate: 
    delete 
    from
        momo_schedule 
    where
        id=?
Hibernate: 
    delete 
    from
        momo_schedule 
    where
        id=?
```

> groupIdë¥¼ nullë¡œ ë³€ê²½í•˜ëŠ” update ì¿¼ë¦¬ëŠ” `orphanRemoval`ì´ ìˆì–´ì„œ ë°œìƒí•œ ì¿¼ë¦¬ì´ë‹¤.
>

ì´ë¥¼ ê°œì„ í•˜ê¸° ìœ„í•´ idë¥¼ ì œì™¸í•œ ì¼ì • ê°’ë§Œì„ ë¹„êµí•˜ì—¬ ë³€ê²½ì ì— ëŒ€í•´ì„œë§Œ ë°ì´í„°ë¥¼ ì¶”ê°€,ì‚­ì œí•˜ëŠ” Dirty Checking ë¡œì§ì„ ì§ì ‘ êµ¬í˜„í•˜ì˜€ë‹¤.

```java
@RequiredArgsConstructor
@Transactional(readOnly = true)
@Service
public class GroupModifyService {
	...
	@Transactional
    public void update(Long hostId, Long groupId, GroupRequest request) {
        ifMemberIsHost(hostId, groupId, (host, group) -> {
            updateGroup(group, request);
            updateSchedules(group, request.getSchedules());
        });
    }

	private void updateSchedules(Group group, List<Schedule> newSchedules) {
        List<Schedule> presentSchedules = group.getSchedules();
        List<Schedule> toBeDeletedSchedules = presentSchedules.stream()
                .filter(schedule -> notContainSchedules(newSchedules, schedule))
                .collect(Collectors.toList());

        List<Schedule> toBeSavedSchedules = newSchedules.stream()
                .filter(schedule -> notContainSchedules(presentSchedules, schedule))
                .collect(Collectors.toList());

        reflectSchedules(group, toBeDeletedSchedules, toBeSavedSchedules);
    }

    private boolean notContainSchedules(List<Schedule> schedules, Schedule schedule) {
        return schedules.stream()
                .noneMatch(schedule::equalsDateTime);
    }

    private void reflectSchedules(Group group, List<Schedule> toBeDeletedSchedules, List<Schedule> toBeSavedIds) {
        if (!toBeDeletedSchedules.isEmpty()) {
            scheduleRepository.deleteAllInSchedules(toBeDeletedSchedules);
        }

        for (Schedule schedule : toBeSavedIds) {
            group.addSchedule(schedule);
        }
    }
}
```

update()ë©”ì„œë“œì˜ ë™ì‘ì„ ì‚´í´ë³´ë©´ ì¼ì • ì •ë³´ë¥¼ ì—…ë°ì´íŠ¸í•˜ëŠ” ë¡œì§ì„ ë”°ë¡œ ë¶„ë¦¬í•œ ê²ƒì„ í™•ì¸í•  ìˆ˜ ìˆë‹¤. ì¼ì • ì •ë³´ ì—…ë°ì´íŠ¸ ë¶€ë¶„ì„ ë¶„ë¦¬í•˜ì—¬ ë³€ê²½ëœ ê°’ì— ëŒ€í•´ì„œë§Œ ë°˜ì˜í•˜ë„ë¡ ìˆ˜ì •í•œ ê²°ê³¼, ì¼ì • ë³€ê²½ì˜ ìœ ë¬´ì™€ ê´€ë ¨ì—†ì´ 3Nê°œì˜ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ë˜ ë¬¸ì œë¥¼ ì¼ì • ë³€ê²½ì´ ë°œìƒí•˜ì˜€ì„ ë•Œë§Œ ì•„ë˜ì˜ ì¿¼ë¦¬ê°€ ë°œìƒí•˜ë„ë¡ ê°œì„ í•  ìˆ˜ ìˆì—ˆë‹¤.

- ì‚­ì œëœ ì¼ì •ì´ ìˆë‹¤ë©´ ì‚­ì œ ì¿¼ë¦¬ 1 + ì¶”ê°€ëœ ì¼ì •ì„ ì¶”ê°€í•˜ëŠ” ì¿¼ë¦¬ N

# ê°œì„  ì „/í›„ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ ìˆ˜ ë¹„êµ

![Untitled](image/20221017-ëª¨ëª¨íŒ€-ì„œë¹„ìŠ¤ì„±ëŠ¥-ê°œì„ ê¸°3/img_5.png)

# ë§ˆì¹˜ë©°

ì´ë¡œì¨ ëª¨ëª¨íŒ€ì˜ ì¿¼ë¦¬ ë¶„ì„ ë° ê°œì„  ì‘ì—…ì´ ëì´ ë‚¬ë‹¤. ì¿¼ë¦¬ ê°œì„  ê³¼ì •ì„ ì§„í–‰í•˜ë©° ì„±ëŠ¥ ê°œì„ ì„ ìœ„í•´ ë§ì€ ê³ ë¯¼ì„ í•˜ê³  ë§ì€ íŠ¸ëŸ¬ë¸” ìŠˆíŒ…ì´ ì¡´ì¬í•˜ì—¬ í˜ë“¤ì—ˆì§€ë§Œ ì‹¤í–‰ë˜ëŠ” ì¿¼ë¦¬ë¥¼ ëŒ€í­ ì¤„ì¼ ìˆ˜ ìˆì–´ì„œ ë³´ëŒì°¼ë‹¤.

ì´ì œ ê°œì„ ëœ ì½”ë“œë¥¼ í†µí•´ ë‹¤ì‹œ ì„±ëŠ¥ í…ŒìŠ¤íŠ¸ë¥¼ ì§„í–‰í•´ë³´ë©° ê°œì„  ì „/í›„ë¥¼ ë¹„êµí•´ë³´ê³ ì í•œë‹¤. í…ŒìŠ¤íŠ¸ ê²°ê³¼ëŠ” ë‹¤ìŒ í¬ìŠ¤íŒ…ì„ í†µí•´ í™•ì¸í•´ë³´ê² ë‹¤.

> ì½”ë“œ ë³€ê²½ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ì˜ PRê³¼ ëª¨ëª¨ ë ˆí¬ì§€í† ë¦¬ë¥¼ í†µí•´ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
> ì½”ë“œ ë³€ê²½ì— ëŒ€í•œ ìì„¸í•œ ë‚´ìš©ì€ ì•„ë˜ì˜ PRê³¼ ëª¨ëª¨ ë ˆí¬ì§€í† ë¦¬ë¥¼ í†µí•´ í™•ì¸í•˜ì‹¤ ìˆ˜ ìˆìŠµë‹ˆë‹¤.
>
> - [woowacourse-teams/2022-momo](https://github.com/woowacourse-teams/2022-momo)
> - [woowacourse-teams/2022-momo/pull/446](https://github.com/woowacourse-teams/2022-momo/pull/446)
>
